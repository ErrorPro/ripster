import GraphQLQuery from './query/GraphQLQuery'

export default function graphql(strings, ...values) {
  const query = strings.reduce((acc, string, index) => {
    let spaces = ''

    for (let i = acc.length - 1; i >= 0 && acc[i] === ' '; i--) {
      spaces += ' '
    }

    const value = values[index - 1]
    let fragment

    if (value instanceof GraphQLQuery) {
      fragment = '... on ' + value.toString()
        .trim()
        .split('\n')
        .map((row, index) =>
          index === 0
            ? row
            : spaces + row
        )
        .join('\n')
    } else {
      fragment = JSON.stringify(value)
    }

    return acc + fragment + string
  })

  return new GraphQLQuery(query)
}
