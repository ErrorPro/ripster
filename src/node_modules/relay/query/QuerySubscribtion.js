import Rx from 'rx'

export default class QuerySubscribtion {
  constructor(query, observable, unpublish) {
    this._query = query
    this._unpublish = unpublish

    this._unsubscribed = false
    this._observable$ = new Rx.BehaviorSubject(observable)
    this._observable = this._observable$
      .takeWhile(() => !this._unsubscribed)
      .flatMapLatest(observable$ => observable$)
  }

  getQuery() {
    return this._query
  }

  setObservable(observable) {
    this._observable$.onNext(observable)
  }

  getObservable() {
    return this._observable
  }

  unsubscribe() {
    this._unsubscribed = true
    this._unpublish()
  }
}
